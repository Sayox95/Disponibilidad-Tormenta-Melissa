<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Confirmación de disponibilidad</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; }
    body { margin: 0; padding: 24px; background:#f7f7fb; color:#1f2937; }
    h1 { margin: 0 0 16px 0; font-size: 22px; }
    .card { background:#fff; border-radius:16px; box-shadow: 0 6px 24px rgba(0,0,0,.06); padding: 20px; margin-bottom: 20px; }
    label { display:block; margin: 10px 0 4px; font-weight:600; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:14px; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align:left; vertical-align: middle;}
    th { background:#fafafa; position: sticky; top:0; z-index:1; }
    .controls { display:flex; gap:12px; flex-wrap: wrap; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; }
    .btn { cursor:pointer; border:0; border-radius:12px; padding:12px 16px; font-weight:600; }
    .btn-primary { background:#111827; color:white; }
    .btn-ghost { background:#fff; border:1px solid #d1d5db; }
    .footer { display:flex; gap:12px; justify-content:flex-end; margin-top:16px; }
    .muted { color:#6b7280; font-size:12px; }
    .hidden { display:none; }
    .table-wrap { max-height: 60vh; overflow:auto; border: 1px solid #eee; border-radius: 12px; }
  </style>
</head>
<body>
  <h1>Confirmación de disponibilidad</h1>

  <div class="card">
    <p class="muted">1) Seleccione el <b>Proceso</b>, 2) complete la cantidad de <b>vehículos asignados</b> del proceso, 3) marque la información por persona y 4) envíe.</p>
    <div class="controls">
      <div style="min-width:260px; flex:1 1 260px;">
        <label for="procesoSelect">Proceso</label>
        <select id="procesoSelect">
          <option value="">-- Seleccione --</option>
        </select>
      </div>
      <div style="min-width:220px;">
        <label for="vehiculosProceso">Vehículos asignados al proceso</label>
        <input id="vehiculosProceso" type="number" min="0" step="1" placeholder="0" />
      </div>
    </div>
  </div>

  <div class="card">
    <div class="controls" style="justify-content: space-between;">
      <div class="pill"><span>Filtro rápido:</span><input id="filtro" type="text" placeholder="Buscar por nombre/cargo..." /></div>
      <div class="muted" id="contador">0 seleccionados</div>
    </div>
    <div class="table-wrap">
      <table id="tabla">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Cargo</th>
            <th>Experiencia en distribución</th>
            <th>Vehículo asignado</th>
            <th>Computadora</th>
            <th>VPN</th>
            <th>VPN funcional</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="footer">
      <button class="btn btn-ghost" id="btnLimpiar">Limpiar</button>
      <button class="btn btn-primary" id="btnEnviar">Enviar</button>
    </div>
    <div class="muted" id="estado"></div>
  </div>

  <script>
    // ⬇️ Reemplazar con la URL del WebApp de Apps Script desplegado (acción "Ejecutar la aplicación como: Yo" y "Quién tiene acceso: Cualquiera con el enlace")
    const GAS_BASE_URL = "https://script.google.com/macros/s/AKfycbzxr_UF2oJ9TBDDFslZOKB-7L2cN36e-Z-pYlX4Veo5sRJTyrXfJ1yagER-Pyr4VVsduw/exec";

    const procesoSelect = document.getElementById('procesoSelect');
    const vehiculosProceso = document.getElementById('vehiculosProceso');
    const tbody = document.querySelector('#tabla tbody');
    const filtro = document.getElementById('filtro');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const btnEnviar = document.getElementById('btnEnviar');
    const estado = document.getElementById('estado');
    const contador = document.getElementById('contador');

    const state = { personal: [], rows: [] };

    function htmlToElement(html) {
      const template = document.createElement('template');
      template.innerHTML = html.trim();
      return template.content.firstChild;
    }

    function updateContador() {
      const totalMarcados = state.rows.filter(r => 
        r.querySelector('input[name="exp"]').checked ||
        r.querySelector('input[name="veh"]').checked ||
        r.querySelector('select[name="pc"]').value ||
        r.querySelector('input[name="vpn"]').checked ||
        r.querySelector('input[name="vpnOk"]').checked
      ).length;
      contador.textContent = totalMarcados + " filas con datos";
    }

    function renderRows(data) {
      tbody.innerHTML = "";
      state.rows = [];
      data.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nombre}</td>
          <td>${p.cargo || ""}</td>
          <td><input type="checkbox" name="exp" /></td>
          <td><input type="checkbox" name="veh" /></td>
          <td>
            <select name="pc">
              <option value="">--</option>
              <option value="Desktop">Desktop</option>
              <option value="Portátil">Portátil</option>
            </select>
          </td>
          <td><input type="checkbox" name="vpn" /></td>
          <td><input type="checkbox" name="vpnOk" disabled /></td>
        `;
        const vpn = tr.querySelector('input[name="vpn"]');
        const vpnOk = tr.querySelector('input[name="vpnOk"]');
        vpn.addEventListener('change', () => {
          vpnOk.disabled = !vpn.checked;
          if (!vpn.checked) vpnOk.checked = false;
          updateContador();
        });
        tr.querySelectorAll('input,select').forEach(el => el.addEventListener('change', updateContador));
        tbody.appendChild(tr);
        state.rows.push(tr);
      });
      updateContador();
    }

    async function cargarProcesos() {
      try {
        const url = GAS_BASE_URL + "?action=procesos";
        const res = await fetch(url);
        const { ok, data, error } = await res.json();
        if (!ok) throw new Error(error || "Error consultando procesos");
        data.sort().forEach(p => {
          const opt = htmlToElement(`<option>${p}</option>`);
          procesoSelect.appendChild(opt);
        });
      } catch (e) {
        estado.textContent = "No se pudieron cargar los procesos: " + e.message;
      }
    }

    async function cargarPersonalPorProceso(proceso) {
      try {
        estado.textContent = "Cargando personal…";
        const url = GAS_BASE_URL + "?action=personal&proceso=" + encodeURIComponent(proceso);
        const res = await fetch(url);
        const { ok, data, error } = await res.json();
        if (!ok) throw new Error(error || "Error consultando personal");
        state.personal = data;
        renderRows(data);
        estado.textContent = "";
      } catch (e) {
        estado.textContent = "Error: " + e.message;
      }
    }

    procesoSelect.addEventListener('change', () => {
      const p = procesoSelect.value;
      if (p) cargarPersonalPorProceso(p);
      tbody.innerHTML = "";
    });

    filtro.addEventListener('input', () => {
      const q = filtro.value.toLowerCase();
      const filtrados = state.personal.filter(p => 
        (p.nombre || "").toLowerCase().includes(q) || (p.cargo || "").toLowerCase().includes(q)
      );
      renderRows(filtrados);
    });

    btnLimpiar.addEventListener('click', () => {
      vehiculosProceso.value = "";
      filtro.value = "";
      renderRows(state.personal);
      estado.textContent = "";
    });

    btnEnviar.addEventListener('click', async () => {
      const proceso = procesoSelect.value;
      if (!proceso) { alert("Seleccione un proceso"); return; }
      const veh = Number(vehiculosProceso.value || 0);
      const rows = Array.from(tbody.querySelectorAll('tr')).map((tr, idx) => {
        const nombre = tr.children[0].textContent.trim();
        const cargo = tr.children[1].textContent.trim();
        return {
          nombre, cargo, idx,
          experienciaDistribucion: tr.querySelector('input[name="exp"]').checked,
          vehiculoAsignado: tr.querySelector('input[name="veh"]').checked,
          computadora: tr.querySelector('select[name="pc"]').value,
          vpn: tr.querySelector('input[name="vpn"]').checked,
          vpnFuncional: tr.querySelector('input[name="vpnOk"]').checked,
        };
      });
      const payload = { proceso, vehiculosAsignadosProceso: veh, entries: rows };
      try {
        estado.textContent = "Enviando…";
        const res = await fetch(GAS_BASE_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json.ok) {
          estado.textContent = "¡Enviado correctamente! Código: " + json.id;
        } else {
          throw new Error(json.error || "Error desconocido");
        }
      } catch (e) {
        estado.textContent = "No se pudo enviar: " + e.message;
      }
    });

    // Inicia
    cargarProcesos();
  </script>
</body>
</html>
